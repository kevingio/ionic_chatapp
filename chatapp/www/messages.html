<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
  <title>Kurir</title>

  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/app.css">

  <!-- un-comment this code to enable service worker
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('service worker installed'))
        .catch(err => console.log('Error', err));
    }
  </script>-->

  <link href="lib/ionic/css/ionic.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">

  <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
  <link href="css/ionic.app.css" rel="stylesheet">
  -->

  <!-- ionic/angularjs js -->
  <script src="lib/ionic/js/ionic.bundle.js"></script>

  <!-- cordova script (this will be a 404 during development) -->
  <script src="cordova.js"></script>

  <!-- your app's js -->
  <script src="js/app.js"></script>
  <script src="js/preload.js"></script>
  <script src="https://unpkg.com/ionicons@4.4.8/dist/ionicons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
</head>
<body ng-app="starter">

<ion-pane style="background: transparent">
  <div id="frame">
    <div class="bar bar-header bg-green">
      <button class="button text-white button-icon icon ion-log-out" id="logout">
      </button>
      <h1 class="title text-white">Kurir</h1>
      <button class="button text-white button-icon icon ion-search">
      </button>
    </div>
    <div class="tabs-striped tabs-top tabs-background-balanced tabs-color-light">
      <div class="tabs">
        <a class="tab-item active" id="recent-chat-tab" href="#">
          Recent Chat
        </a>
        <a class="tab-item" id="online-tab" href="#">
          Online
        </a>
      </div>
    </div>
    <div class="list" style="margin-top: 92px;">
      <div>
        <a class="item item-avatar" href="#" v-for="(chat,index) in filteredList" @click="goToChat(chat)">
          <img src="https://emilcarlsson.se/assets/harveyspecter.png">
          <h2 v-if="chat.type == 'private'">{{ chat.name }}</h2>
          <h2 v-else>{{ chat.room_name }}</h2>
          <p>chat with me!</p>
        </a>
      </div>
    </div>
    <button class="btn-danger btn btn-lg icon ion-android-add" style="position: fixed; right: 7%; bottom: 5%; -webkit-border-radius: 80%;-moz-border-radius: 80%;border-radius: 80%; padding: .2rem .75rem;">
    </button>
  </div>
</ion-pane>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js" charset="utf-8"></script>
<script>
  $('#recent-chat-tab').on('click', function () {
    $('#recent-chat-tab').addClass('active');
    $('#online-tab').removeClass('active');
  });
  $('#online-tab').on('click', function () {
    $('#recent-chat-tab').removeClass('active');
    $('#online-tab').addClass('active');
  });
  $('.item-avatar').on('click', function () {
    window.location.href = 'chat.html';
  });
  $('#logout').on('click', function () {
    window.location.href = '/';
  });

    new Vue ({
        el: "#app",
        data: {
            items: [
                {a: 1},
                {b: 2},
                {c: 2},
                {c: 2}
            ]
        },
        mounted() {
            axios.get('http://localhost:3000/getRecentRoomChats')
            .then((response) => {
                console.log(response.data);
            });
        }
    })
</script>
<script type="text/javascript">
  var halo = new Vue({
    el: '#frame',
    data: {
      chats: [],
      total_chat: 0,
      total_user: 0,
      online_users: [],
      selected_room: null,
      state: 'chat',
      activeRoom: null,
      activeChatMessage: [],
      user: {
        name: 'Kurir'
      },
      socket : io('localhost:3000'),
      message: '',
      invitedUsers: [],
      availableUsers: [],
      filterSearch: '',
      newGroupChat: {
        name: '',
        users: []
      },
    },
    mounted() {

    },
    computed: {
      filteredList() {
        if(this.chats) {
          return this.chats.filter(chat => {
            if(chat.type == 'private') {
              return chat.name.toLowerCase().includes(this.filterSearch.toLowerCase())
            } else {
              return chat.room_name.toLowerCase().includes(this.filterSearch.toLowerCase())
            }
          })
        }
      },
      filteredOnlineUsers() {
        if(this.online_users) {
          return this.online_users.filter(chat => {
            return chat.name.toLowerCase().includes(this.filterSearch.toLowerCase())
          })
        }
      }
    },
    created() {
      this.initChats();
    },
    methods: {
      initChats() {
        let vm = this;
        let cookie = document.cookie.split(';');
        let user_temp  = JSON.parse(cookie[1]).user;
        vm.user = user_temp;
        axios.get('http://localhost:3000/getOnlineUsers?user_id=' + user_temp.id)
          .then(function (response) {
            vm.online_users = response.data.users;
          });
        axios.get('http://localhost:3000/getRecentRoomChats?user_id=' + user_temp.id)
          .then(function (response) {
            vm.chats = response.data.chats;
            vm.total_chat = response.data.total;
            vm.chats.forEach(function (chat) {
              if (chat.type == 'private') {
                var temp = chat.room_name.replace(vm.user.name, '');
                chat.name = temp;
              }
            });
          });
      },
      goToChat(index) {
        var cookie = document.cookie.split(';');
        let user_temp  = JSON.parse(cookie[1]);
        user_temp.user.room = index;
        document.cookie = JSON.stringify(user_temp);
        window.location.href = 'chat.html';
      }
    }
  });
</script>
</body>
</html>
